# Keeps this fork's main branch in sync with the upstream (mutativ/dokku-dashboard)
# and dispatches a deploy event to the backend-monorepo.
#
# Required fork secrets:
#   MONOREPO_DISPATCH_TOKEN â€” fine-grained PAT with Contents+Actions write on stake-dao/backend-monorepo

name: Sync fork from upstream

on:
  schedule:
    - cron: '0 */6 * * *'  # every 6 hours
  workflow_dispatch:

jobs:
  sync-upstream:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch upstream
        run: git remote add upstream https://github.com/mutativ/dokku-dashboard.git || true

      - name: Merge upstream/main
        id: merge
        run: |
          git fetch upstream main
          UPSTREAM_SHA=$(git rev-parse upstream/main)
          LOCAL_SHA=$(git rev-parse HEAD)

          if [ "$UPSTREAM_SHA" = "$LOCAL_SHA" ]; then
            echo "Already up to date with upstream ($UPSTREAM_SHA)"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            UPSTREAM_SHORT=$(echo "$UPSTREAM_SHA" | cut -c1-7)
            UPSTREAM_MSG=$(git log upstream/main -1 --format="%s")
            git merge upstream/main --no-edit -m "chore: sync from upstream mutativ/dokku-dashboard@${UPSTREAM_SHORT}

${UPSTREAM_MSG}"
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "sha=$UPSTREAM_SHORT" >> $GITHUB_OUTPUT
            echo "msg=$UPSTREAM_MSG" >> $GITHUB_OUTPUT
          fi

      - name: Push fork
        if: steps.merge.outputs.changed == 'true'
        run: git push origin main

      - name: Dispatch sync to backend-monorepo
        if: steps.merge.outputs.changed == 'true' && secrets.MONOREPO_DISPATCH_TOKEN != ''
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.MONOREPO_DISPATCH_TOKEN }}
          repository: stake-dao/backend-monorepo
          event-type: sync-dokku-dashboard
          client-payload: |
            {
              "sha": "${{ steps.merge.outputs.sha }}",
              "message": "${{ steps.merge.outputs.msg }}"
            }
